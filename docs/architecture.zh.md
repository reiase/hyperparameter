# æ¶æ„æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç» Hyperparameter çš„å†…éƒ¨æ¶æ„ï¼ŒåŒ…æ‹¬ Rust åç«¯å’Œ Python å‰ç«¯å¦‚ä½•ååŒå·¥ä½œã€‚

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Python ç”¨æˆ·ä»£ç                           â”‚
â”‚  @auto_param, param_scope, loader.load() ç­‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Python API å±‚                              â”‚
â”‚  hyperparameter/api.py, hyperparameter/cli.py               â”‚
â”‚  - è£…é¥°å™¨ (@auto_param)                                     â”‚
â”‚  - ä¸Šä¸‹æ–‡ç®¡ç†å™¨ (param_scope)                                â”‚
â”‚  - CLI å‚æ•°è§£æ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å­˜å‚¨æŠ½è±¡å±‚                                  â”‚
â”‚  hyperparameter/storage.py                                  â”‚
â”‚  - TLSKVStorage (çº¿ç¨‹æœ¬åœ°å­˜å‚¨)                               â”‚
â”‚  - è‡ªåŠ¨åç«¯é€‰æ‹©                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Rust åç«¯             â”‚    â”‚   Python å›é€€åç«¯            â”‚
â”‚   (librbackend.so)      â”‚    â”‚   (çº¯ Python å­—å…¸)          â”‚
â”‚   - xxhash é”®å“ˆå¸Œ       â”‚    â”‚   - Rust ä¸å¯ç”¨æ—¶ä½¿ç”¨        â”‚
â”‚   - çº¿ç¨‹æœ¬åœ°å­˜å‚¨        â”‚    â”‚   - ç›¸åŒçš„ API å¥‘çº¦          â”‚
â”‚   - æ— é”è¯»å–            â”‚    â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç»„ä»¶è¯¦è§£

### 1. Python API å±‚ (`hyperparameter/api.py`)

è¿™æ˜¯ç”¨æˆ·ç›´æ¥äº¤äº’çš„éƒ¨åˆ†ã€‚

**æ ¸å¿ƒç±»:**

- **`param_scope`**: åˆ›å»ºæ–°å‚æ•°ä½œç”¨åŸŸçš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚
  ```python
  with param_scope(foo=1, bar=2) as ps:
      # ps.foo() è¿”å› 1
      # åµŒå¥—ä½œç”¨åŸŸä»çˆ¶ä½œç”¨åŸŸç»§æ‰¿
  ```

- **`_ParamAccessor`**: å¤„ç† `param_scope.x.y.z | default` è¯­æ³•ã€‚
  ```python
  # è¿™ä¸ªé“¾å¼è°ƒç”¨: param_scope.model.layers.size | 10
  # åˆ›å»º: _ParamAccessor(root, "model.layers.size")
  # `|` è¿ç®—ç¬¦è°ƒç”¨ get_or_else(10)
  ```

- **`auto_param` è£…é¥°å™¨**: æ£€æŸ¥å‡½æ•°ç­¾åå¹¶æ³¨å…¥å€¼ã€‚
  ```python
  @auto_param("model")
  def foo(hidden_size=256):  # æŸ¥æ‰¾ "model.hidden_size"
      pass
  ```

### 2. å­˜å‚¨å±‚ (`hyperparameter/storage.py`)

å­˜å‚¨å±‚æŠ½è±¡äº†åº•å±‚çš„é”®å€¼å­˜å‚¨ã€‚

**æ ¸å¿ƒç‰¹æ€§:**

- **çº¿ç¨‹æœ¬åœ°å­˜å‚¨ (TLS)**: æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„å‚æ•°æ ˆã€‚
- **ä½œç”¨åŸŸæ›´æ–°**: æ›´æ”¹ä»…é™å½“å‰ä½œç”¨åŸŸï¼Œé€€å‡ºæ—¶å›æ»šã€‚
- **åç«¯é€‰æ‹©**: å¦‚æœå¯ç”¨åˆ™è‡ªåŠ¨ä½¿ç”¨ Rust åç«¯ã€‚

```python
class TLSKVStorage:
    """å¸¦ä½œç”¨åŸŸæ ˆçš„çº¿ç¨‹æœ¬åœ°é”®å€¼å­˜å‚¨"""
    
    def enter(self):
        """å°†æ–°ä½œç”¨åŸŸå‹å…¥æ ˆ"""
        
    def exit(self):
        """å¼¹å‡ºå½“å‰ä½œç”¨åŸŸï¼Œå›æ»šæ›´æ”¹"""
        
    def get(self, key: str) -> Any:
        """åœ¨å½“å‰ä½œç”¨åŸŸæŸ¥æ‰¾é”®ï¼Œç„¶åæŸ¥æ‰¾çˆ¶ä½œç”¨åŸŸ"""
        
    def put(self, key: str, value: Any):
        """ä»…åœ¨å½“å‰ä½œç”¨åŸŸè®¾ç½®é”®"""
```

### 3. Rust åç«¯ (`src/core/`, `src/py/`)

Rust åç«¯æä¾›é«˜æ€§èƒ½çš„å‚æ•°è®¿é—®ã€‚

**ä¸ºä»€ä¹ˆç”¨ Rust?**

1. **ç¼–è¯‘æ—¶é”®å“ˆå¸Œ**: åƒ `"model.layers.size"` è¿™æ ·çš„é”®åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨ `xxhash` å“ˆå¸Œï¼Œæ¶ˆé™¤äº†è¿è¡Œæ—¶å­—ç¬¦ä¸²å“ˆå¸Œå¼€é”€ã€‚

2. **æ— é”è¯»å–**: çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ„å‘³ç€è¯»å–æ—¶æ²¡æœ‰äº’æ–¥é”ç«äº‰ã€‚

3. **é›¶æ‹·è´å­—ç¬¦ä¸²å¤„ç†**: Rust çš„å­—ç¬¦ä¸²å¤„ç†é¿å…äº† Python å­—ç¬¦ä¸²é©»ç•™çš„å¼€é”€ã€‚

**æ ¸å¿ƒ Rust ç»„ä»¶:**

```rust
// src/core/src/storage.rs
pub struct ThreadLocalStorage {
    stack: Vec<HashMap<u64, Value>>,  // ä½œç”¨åŸŸæ ˆ
}

// src/core/src/xxh.rs
pub const fn xxhash(s: &str) -> u64 {
    // ç¼–è¯‘æ—¶ xxhash64
}

// src/core/src/api.rs
pub fn get_param<T>(key_hash: u64, default: T) -> T {
    // é€šè¿‡é¢„è®¡ç®—å“ˆå¸Œå¿«é€ŸæŸ¥æ‰¾
}
```

**Python ç»‘å®š (`src/py/`):**

ä½¿ç”¨ PyO3 å°† Rust å‡½æ•°æš´éœ²ç»™ Python:

```rust
#[pyfunction]
fn get_entry(key_hash: u64) -> PyResult<PyObject> {
    // ä» Python è°ƒç”¨ï¼Œä½¿ç”¨é¢„è®¡ç®—çš„å“ˆå¸Œ
}
```

### 4. é…ç½®åŠ è½½å™¨ (`hyperparameter/loader.py`)

åŠ è½½å™¨å¤„ç†é…ç½®æ–‡ä»¶è§£æå’Œå¤„ç†ã€‚

**å¤„ç†æµæ°´çº¿:**

```
æ–‡ä»¶ â†’ è§£æ â†’ åˆå¹¶ â†’ æ’å€¼ â†’ æ ¡éªŒ â†’ å­—å…¸/å¯¹è±¡
```

1. **è§£æ**: æ”¯æŒ TOMLã€JSONã€YAML
2. **åˆå¹¶**: æ·±åº¦åˆå¹¶å¤šä¸ªé…ç½®ï¼ˆåè€…è¦†ç›–å‰è€…ï¼‰
3. **æ’å€¼**: è§£æ `${variable}` å¼•ç”¨
4. **æ ¡éªŒ**: å¯é€‰çš„åŸºäºç±»ç±»å‹æç¤ºçš„ Schema æ ¡éªŒ

```python
def load(path, schema=None):
    config = _load_and_merge(path)
    config = _resolve_interpolations(config)
    if schema:
        return validate(config, schema)
    return config
```

## æ•°æ®æµç¤ºä¾‹

è®©æˆ‘ä»¬è¿½è¸ªè¿è¡Œä»¥ä¸‹ä»£ç æ—¶å‘ç”Ÿäº†ä»€ä¹ˆ:

```python
from hyperparameter import auto_param, param_scope

@auto_param("model")
def train(lr=0.001):
    print(lr)

with param_scope(**{"model.lr": 0.01}):
    train()
```

**é€æ­¥åˆ†æ:**

1. **`param_scope(**{"model.lr": 0.01})`**:
   - åˆ›å»ºæ–°çš„ `TLSKVStorage` ä½œç”¨åŸŸ
   - è®¡ç®—å“ˆå¸Œ: `xxhash("model.lr")` â†’ `0x1234...`
   - å­˜å‚¨: `{0x1234...: 0.01}` åˆ°å½“å‰çº¿ç¨‹çš„ä½œç”¨åŸŸæ ˆ

2. **`train()` è¢«è°ƒç”¨**:
   - `@auto_param` åŒ…è£…å™¨è¿è¡Œ
   - å¯¹æ¯ä¸ªæœ‰é»˜è®¤å€¼çš„å‚æ•° (`lr=0.001`):
     - è®¡ç®—å“ˆå¸Œ: `xxhash("model.lr")`
     - è°ƒç”¨ `storage.get_entry(0x1234...)`
     - Rust åç«¯è¿”å› `0.01`
   - è°ƒç”¨ `train(lr=0.01)`

3. **ä½œç”¨åŸŸé€€å‡º**:
   - `param_scope.__exit__()` è¢«è°ƒç”¨
   - ä»æ ˆä¸­å¼¹å‡ºä½œç”¨åŸŸ
   - `model.lr` ä¸å†å¯è®¿é—®

## æ€§èƒ½ç‰¹å¾

### ä¸ºä»€ä¹ˆ Hyperparameter å¿«

| æ“ä½œ | Hydra/OmegaConf | Hyperparameter |
| :--- | :--- | :--- |
| é”®æŸ¥æ‰¾ | è¿è¡Œæ—¶å­—ç¬¦ä¸²å“ˆå¸Œ | é¢„è®¡ç®— xxhash |
| ç±»å‹æ£€æŸ¥ | æ¯æ¬¡è®¿é—®éƒ½æ£€æŸ¥ | å¯é€‰ï¼ŒåŠ è½½æ—¶æ£€æŸ¥ |
| çº¿ç¨‹å®‰å…¨ | å…¨å±€é” | çº¿ç¨‹æœ¬åœ°ï¼ˆæ— é”ï¼‰ |
| å†…å­˜ | Python å­—å…¸ + åŒ…è£…å™¨ | Rust HashMap |

### ä½•æ—¶ä½¿ç”¨å“ªç§è®¿é—®æ¨¡å¼

| æ¨¡å¼ | é€Ÿåº¦ | ä½¿ç”¨åœºæ™¯ |
| :--- | :--- | :--- |
| `@auto_param` æ³¨å…¥ | ğŸš€ğŸš€ğŸš€ æœ€å¿« | çƒ­å¾ªç¯ï¼Œæ€§èƒ½å…³é”® |
| `with param_scope() as ps: ps.x` | ğŸš€ğŸš€ å¿« | å¤§å¤šæ•°ä»£ç  |
| `param_scope.x` (å…¨å±€) | ğŸš€ ä¸­ç­‰ | ä¾¿æ·è®¿é—®ï¼Œä¸€æ¬¡æ€§è®¿é—® |

## çº¿ç¨‹å®‰å…¨æ¨¡å‹

```
çº¿ç¨‹ 1                      çº¿ç¨‹ 2
â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€
param_scope(a=1)           
â”‚                          param_scope(a=2)
â”‚   a = 1                  â”‚   a = 2
â”‚                          â”‚
â””â”€â”€ é€€å‡º                   â””â”€â”€ é€€å‡º
    a = æœªå®šä¹‰                 a = æœªå®šä¹‰
```

æ¯ä¸ªçº¿ç¨‹æœ‰**ç‹¬ç«‹çš„ä½œç”¨åŸŸæ ˆ**ã€‚ä¸€ä¸ªçº¿ç¨‹çš„æ›´æ”¹æ°¸è¿œä¸ä¼šå½±å“å¦ä¸€ä¸ªçº¿ç¨‹ã€‚

**`frozen()` ç”¨äºè·¨çº¿ç¨‹é»˜è®¤å€¼:**

```python
with param_scope(a=1):
    param_scope.frozen()  # å°†å½“å‰ä½œç”¨åŸŸå¿«ç…§ä¸ºå…¨å±€é»˜è®¤å€¼
    
# æ–°çº¿ç¨‹å°†ä»¥ a=1 ä½œä¸ºåˆå§‹çŠ¶æ€
```

## æ‰©å±• Hyperparameter

### è‡ªå®šä¹‰å­˜å‚¨åç«¯

```python
from hyperparameter.storage import TLSKVStorage

class RedisBackedStorage(TLSKVStorage):
    """ç¤ºä¾‹: ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿçš„ Redis åç«¯å­˜å‚¨"""
    
    def get(self, key):
        # å…ˆå°è¯•æœ¬åœ°
        value = super().get(key)
        if value is None:
            # å›é€€åˆ° Redis
            value = self.redis.get(key)
        return value
```

### è‡ªå®šä¹‰ç±»å‹è½¬æ¢

```python
from hyperparameter.loader import _coerce_type

def _coerce_type(value, target_type):
    # æ·»åŠ è‡ªå®šä¹‰ç±»å‹å¤„ç†
    if target_type is MyCustomType:
        return MyCustomType.from_string(value)
    # ... ç°æœ‰é€»è¾‘
```

## æ–‡ä»¶ç»“æ„

```
hyperparameter/
â”œâ”€â”€ __init__.py          # å…¬å…± API å¯¼å‡º
â”œâ”€â”€ api.py               # æ ¸å¿ƒ Python API (param_scope, auto_param)
â”œâ”€â”€ cli.py               # CLI æ”¯æŒ (launch, run_cli)
â”œâ”€â”€ loader.py            # é…ç½®åŠ è½½ã€æ’å€¼ã€æ ¡éªŒ
â”œâ”€â”€ storage.py           # å­˜å‚¨æŠ½è±¡ã€TLS
â””â”€â”€ tune.py              # è¶…å‚è°ƒä¼˜å·¥å…·

src/
â”œâ”€â”€ core/                # Rust æ ¸å¿ƒåº“
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ api.rs       # å…¬å…± Rust API
â”‚       â”œâ”€â”€ storage.rs   # çº¿ç¨‹æœ¬åœ°å­˜å‚¨
â”‚       â”œâ”€â”€ value.rs     # å€¼ç±»å‹å¤„ç†
â”‚       â””â”€â”€ xxh.rs       # ç¼–è¯‘æ—¶ xxhash
â”œâ”€â”€ macros/              # Rust è¿‡ç¨‹å®
â””â”€â”€ py/                  # PyO3 Python ç»‘å®š
```

